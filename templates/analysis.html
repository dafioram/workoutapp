<!doctype html>
<html>
<head>
  <title>Workout Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>Workout Analysis for {{ username }}</h1>
  <nav>
    <a href="{{ url_for('index') }}">Generator</a> |
    <a href="{{ url_for('history') }}">History</a> |
    <a href="{{ url_for('exercises') }}">All Exercises</a> |
    <a href="{{ url_for('analysis') }}">Analysis</a>
  </nav>
  <hr>

  <div>
    <button onclick="setView('week')">Weekly</button>
    <button onclick="setView('month')">Monthly</button>
  </div>

  <h2>Exercise vs Rest Over Time</h2>
  <canvas id="trendChart"></canvas>

  <h2>Total Workout Time</h2>
  <canvas id="totalChart"></canvas>

  <h2>Muscle Group Distribution</h2>
  <canvas id="muscleChart"></canvas>

  <h2>Number of Workouts</h2>
  <canvas id="workoutCountChart"></canvas>

  <script>
    const trendLabels = {{ trend_labels|tojson }};
    const trendExercise = {{ trend_exercise|tojson }};
    const trendRest = {{ trend_rest|tojson }};
    const weekly = {{ weekly|tojson }};
    const monthly = {{ monthly|tojson }};
    const weeklyWorkoutCounts = {{ weekly_workout_counts|tojson }};
    const monthlyWorkoutCounts = {{ monthly_workout_counts|tojson }};
    let currentView = "week";

    // Convert seconds â†’ minutes (1 decimal)
    function toMinutes(val) {
      return (val / 60).toFixed(1);
    }
    function toMinutesArray(arr) {
      return arr.map(v => toMinutes(v));
    }

    // Trend Chart (now in minutes)
    const trendChart = new Chart(
      document.getElementById('trendChart'),
      {
        type: 'line',
        data: {
          labels: trendLabels,
          datasets: [
            { label: "Exercise Time (min)", data: toMinutesArray(trendExercise), borderColor: "green", fill: false },
            { label: "Rest Time (min)", data: toMinutesArray(trendRest), borderColor: "red", fill: false }
          ]
        },
        options: {
          scales: {
            y: { title: { display: true, text: "Minutes" } }
          }
        }
      }
    );

    // Build Totals (convert to minutes)
    function buildTotals(data) {
      const labels = Object.keys(data).sort();
      const exercise = labels.map(l => toMinutes(data[l].exercise));
      const rest = labels.map(l => toMinutes(data[l].rest));
      return { labels, exercise, rest };
    }

    let totals = buildTotals(weekly);
    const totalChart = new Chart(
      document.getElementById('totalChart'),
      {
        type: 'bar',
        data: {
          labels: totals.labels,
          datasets: [
            { label: "Exercise (min)", data: totals.exercise, backgroundColor: "green" },
            { label: "Rest (min)", data: totals.rest, backgroundColor: "red" }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true, title: { display: true, text: "Minutes" } }
          }
        }
      }
    );

    // Muscle Group Distribution Chart (convert to minutes)
    function buildMuscles(data) {
      const labels = Object.keys(data).sort();
      const muscleSet = new Set();
      labels.forEach(l => Object.keys(data[l].muscles).forEach(m => muscleSet.add(m)));
      const muscles = Array.from(muscleSet);
      const datasets = muscles.map((m, i) => ({
        label: m,
        data: labels.map(l => data[l].muscles[m] ? toMinutes(data[l].muscles[m]) : 0),
        backgroundColor: `hsl(${i*50 % 360},70%,60%)`
      }));
      return { labels, datasets };
    }

    let muscles = buildMuscles(weekly);
    const muscleChart = new Chart(
      document.getElementById('muscleChart'),
      {
        type: 'bar',
        data: { labels: muscles.labels, datasets: muscles.datasets },
        options: {
          responsive: true,
          scales: {
            x: { stacked: true },
            y: { stacked: true, title: { display: true, text: "Minutes" } }
          },
          plugins: {
            title: { display: true, text: "Muscle Group Time (min)" }
          }
        }
      }
    );

    // Workout Count Chart (unchanged)
    function buildWorkoutCounts(data) {
      const labels = Object.keys(data).sort();
      const counts = labels.map(l => data[l]);
      return { labels, counts };
    }

    let workoutCounts = buildWorkoutCounts(weeklyWorkoutCounts);
    const workoutCountChart = new Chart(
      document.getElementById('workoutCountChart'),
      {
        type: 'line',
        data: {
          labels: workoutCounts.labels,
          datasets: [{
            label: "Number of Workouts",
            data: workoutCounts.counts,
            backgroundColor: "rgba(75, 192, 192, 0.5)",
            borderColor: "rgba(75, 192, 192, 1)",
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Number of Workouts' }
            },
            x: { title: { display: true, text: currentView === 'week' ? 'Week' : 'Month' } }
          },
          plugins: {
            title: { display: true, text: 'Number of Workouts per ' + (currentView === 'week' ? 'Week' : 'Month') }
          }
        }
      }
    );

    // Update when switching views
    function setView(view) {
      currentView = view;
      const data = (view === "week") ? weekly : monthly;
      const workoutCountData = (view === "week") ? weeklyWorkoutCounts : monthlyWorkoutCounts;

      // Update Total Chart
      let totals = buildTotals(data);
      totalChart.data.labels = totals.labels;
      totalChart.data.datasets[0].data = totals.exercise;
      totalChart.data.datasets[1].data = totals.rest;
      totalChart.update();

      // Update Muscle Chart
      let muscles = buildMuscles(data);
      muscleChart.data.labels = muscles.labels;
      muscleChart.data.datasets = muscles.datasets;
      muscleChart.update();

      // Update Workout Count Chart
      let workoutCounts = buildWorkoutCounts(workoutCountData);
      workoutCountChart.data.labels = workoutCounts.labels;
      workoutCountChart.data.datasets[0].data = workoutCounts.counts;
      workoutCountChart.options.scales.x.title.text = view === 'week' ? 'Week' : 'Month';
      workoutCountChart.options.plugins.title.text = 'Number of Workouts per ' + (view === 'week' ? 'Week' : 'Month');
      workoutCountChart.update();
    }
  </script>
</body>
</html>